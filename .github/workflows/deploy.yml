name: ðŸš€ Deploy to VPS

on:
  push:
    branches:
      - main  # se ejecuta automÃ¡ticamente cuando haces push a main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§­ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy to VPS via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script_stop: false
          script: |
            set +e  # âœ… No detiene la ejecuciÃ³n si un comando devuelve error

            echo "ðŸ“‚ Iniciando deploy como usuario: $(whoami)"
            cd /var/www/sppjsah

            # âœ… Asegurar que Git confÃ­e en el repo
            git config --global --add safe.directory /var/www/sppjsah

            # ðŸ”„ Actualizar repositorio
            echo "ðŸ”„ Actualizando repositorio..."
            git fetch --all
            git reset --hard origin/main

            # ðŸ§  Cargar entorno Node
            export NVM_DIR="/home/${USER}/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            # âš™ï¸ Verificar versiÃ³n Node y npm
            echo "ðŸ§© Node version: $(node -v)"
            echo "ðŸ§© NPM version: $(npm -v)"

            # ðŸ“¦ Instalar dependencias
            echo "ðŸ“¦ Instalando dependencias..."
            npm ci --omit=dev || npm install --omit=dev

            # ðŸ—ƒï¸ Ejecutar migraciones (sin romper deploy)
            echo "ðŸ§± Ejecutando migraciones..."
            npx sequelize-cli db:migrate || echo "âš ï¸ Migraciones fallaron, continuando..."

            # âœ… Verificar si el Excel existe
            if [ -f "/var/www/sppjsah/Excel/actualizada.xlsx" ]; then
              echo "ðŸŸ¢ Archivo Excel detectado correctamente."
            else
              echo "âš ï¸ Advertencia: No se encontrÃ³ /Excel/actualizada.xlsx"
            fi

            # ðŸ” Reiniciar PM2
            echo "â™»ï¸ Reiniciando PM2..."
            if pm2 describe sppjsah > /dev/null; then
              pm2 restart sppjsah --update-env
            else
              pm2 start app.js --name sppjsah
            fi

            pm2 save

            echo "âœ… Deploy completado exitosamente"
