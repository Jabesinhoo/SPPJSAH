name: ðŸš€ Deploy to VPS (SPPJSAH)

on:
  push:
    branches:
      - main  # cada vez que hagas push a main, se despliega automÃ¡ticamente

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy to VPS
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}        # debe ser 'jabesinho'
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script_stop: true                       # si algo falla, detiene el deploy
          script: |
            set -e  # Detiene si un comando falla

            echo "ðŸ“‚ Iniciando deploy como usuario: $(whoami)"
            cd /var/www/sppjsah

            # âœ… Asegurar que Git confÃ­e en el repo
            git config --global --add safe.directory /var/www/sppjsah

            # ðŸ”„ Actualizar cÃ³digo
            echo "ðŸ”„ Actualizando repositorio..."
            git fetch --all
            git reset --hard origin/main

            # ðŸ§  Cargar entorno Node de jabesinho
            export NVM_DIR="/home/jabesinho/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            # âš™ï¸ Verificar versiÃ³n Node y npm
            echo "ðŸ§© Node version: $(node -v)"
            echo "ðŸ§© NPM version: $(npm -v)"

            # ðŸ“¦ Instalar dependencias en modo producciÃ³n
            npm ci --omit=dev

            # ðŸ—ƒï¸ Ejecutar migraciones (sin romper si hay duplicados)
            echo "ðŸ§± Ejecutando migraciones..."
            npx sequelize-cli db:migrate || echo "âš ï¸ Migraciones con conflictos, continuando..."

            # ðŸ” Reiniciar PM2
            echo "â™»ï¸ Reiniciando proceso PM2..."
            if pm2 describe sppjsah > /dev/null; then
              pm2 restart sppjsah --update-env
            else
              pm2 start app.js --name sppjsah
            fi

            pm2 save
            echo "âœ… Deploy completado exitosamente"
